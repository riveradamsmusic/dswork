<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RiverAdam$</title>
    <style>
        /* --- Google Font Imports --- */
        @import url('https://fonts.googleapis.com/css2?family=Caveat:wght@400;700&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Rubik+Doodle+Shadow&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Comic+Neue&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Permanent+Marker&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=VT323&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Major+Mono+Display&display=swap');

        /* --- CSS Variables --- */
        :root {
            --font-caveat: 'Caveat', cursive;
            --font-press-start: 'Press Start 2P', cursive;
            --font-rubik: 'Rubik Doodle Shadow', cursive;
            --font-comic: 'Comic Neue', cursive;
            --font-marker: 'Permanent Marker', cursive;
            --font-vt323: 'VT323', monospace;
            --font-major-mono: 'Major Mono Display', monospace;

            --primary-color: #9b59b6;
            --secondary-color: #6a3d8a;
            --glitch-cyan: cyan;
            --glitch-magenta: magenta;
        }

        /* --- Base Styles --- */
        body {
            background-image: url('GITBACK/wall.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            background-attachment: fixed;
            height: 100vh; /* Fallback */
            height: 100dvh;
            min-height: 100vh; /* Fallback */
            min-height: 100dvh;
            display: grid;
            place-items: center;
            margin: 0;
            padding: 0;
            overflow: hidden;
            position: relative;
            color: white;
        }

        .handwritten {
            font-family: var(--font-caveat);
            user-select: none;
            letter-spacing: 1px;
        }

        /* --- Emoji Wrapper --- */
        .emoji-wrapper {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0;
            cursor: pointer;
            z-index: 10;
        }

        #emoji {
            font-size: 80px;
            display: inline-block;
            width: 80px;
            height: 80px;
            line-height: 1;
            text-align: center;
            transition: transform 0.2s ease, opacity 0.5s ease;
        }

        #emoji:active {
            transform: scale(0.8);
        }

        #emoji.fade-out {
            opacity: 0;
        }

        /* --- Glitch Text --- */
        #text {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 24px;
            display: none;
            opacity: 0;
            z-index: 5;
            text-align: center;
            pointer-events: none;
        }

        /* Font Utility Classes */
        .font-caveat { font-family: var(--font-caveat); }
        .font-press-start { font-family: var(--font-press-start); }
        .font-rubik { font-family: var(--font-rubik); }
        .font-comic { font-family: var(--font-comic); }
        .font-marker { font-family: var(--font-marker); }
        .font-vt323 { font-family: var(--font-vt323); }
        .font-major-mono { font-family: var(--font-major-mono); }

        /* --- Animations --- */
        @keyframes text-glitch {
            0%, 5%, 100% { transform: translate(-50%, -50%); opacity: 1; text-shadow: none; }
            1% { transform: translate(calc(-50% - 15px), calc(-50% + 10px)) scale(1.3) rotate(5deg); opacity: 0.8; text-shadow: 5px 5px 0 var(--glitch-magenta), -5px -5px 0 var(--glitch-cyan); }
            2% { transform: translate(calc(-50% + 12px), calc(-50% - 8px)) scale(0.7) rotate(-10deg); opacity: 0.6; clip-path: polygon(0 0, 100% 0, 100% 60%, 0 60%); }
            3% { transform: translate(calc(-50% - 8px), calc(-50% + 15px)) skew(20deg) scale(1.2); opacity: 0.9; color: var(--glitch-cyan); }
            4% { transform: translate(calc(-50% + 5px), calc(-50% - 12px)) scale(0.8) rotate(15deg); opacity: 0.7; color: var(--glitch-magenta); text-shadow: 3px 3px 5px black; }
        }

        @keyframes glitch-blink {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.2; }
        }

        @keyframes glitch-color-shift {
            0%, 100% { color: white; }
            25% { color: #ff00ff; }
            50% { color: #00ffff; }
            75% { color: #ffff00; }
        }

        @keyframes glitch-move {
            0% { transform: translate(-50%, -50%); }
            20% { transform: translate(calc(-50% - 10px), calc(-50% + 5px)); }
            40% { transform: translate(calc(-50% + 8px), calc(-50% - 8px)); }
            60% { transform: translate(calc(-50% - 5px), calc(-50% + 10px)); }
            80% { transform: translate(calc(-50% + 10px), calc(-50% - 5px)); }
        }

        .intense-glitch {
            animation: text-glitch 0.1s infinite, glitch-blink 0.3s infinite, glitch-color-shift 1s infinite, glitch-move 2s infinite;
        }

        /* --- Slideshow Styles --- */
        .slideshow-container {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 90px;
            height: 90px;
            z-index: 10;
            overflow: hidden;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            background-color: rgba(20, 20, 20, 0.3);
            display: none;
        }

        .slide {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
            opacity: 0;
            transition: opacity 1s ease;
        }

        .slide.active {
            opacity: 1;
        }

        /* Loading Spinner for Slideshow */
        .spinner {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100px;
            height: 12px;
            background: #222;
            border: 2px solid var(--primary-color);
            z-index: 2;
            display: none;
        }

        .spinner::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 0%;
            background: repeating-linear-gradient(45deg, var(--primary-color), var(--primary-color) 4px, var(--secondary-color) 4px, var(--secondary-color) 8px);
            animation: load-bar 2s steps(10) infinite;
        }

        @keyframes load-bar {
            to { width: 100%; }
        }

        /* --- Top Right Image --- */
        .top-right-images {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 90px;
            height: 90px;
            z-index: 1;
            display: none;
            flex-direction: column;
            gap: 10px;
        }

        .top-right-image {
            width: 100%;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
        }

        /* --- Flick Instruction --- */
        .flick-instruction {
            position: fixed;
            top: calc(20% - 65px); /* Adjusted from 1.7cm */
            left: 10%;
            font-family: var(--font-caveat);
            color: white;
            font-size: 24px;
            display: none;
            flex-direction: column;
            align-items: center;
            z-index: 25;
            pointer-events: none;
        }

        .flick-arrow {
            font-size: 22px;
            margin-top: -15px;
            animation: bounce 1s infinite alternate;
        }

        @keyframes bounce {
            to { transform: translateY(10px); }
        }

        /* --- Music Carousel --- */
        .carousel-container {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(calc(-50% + 19px), calc(-50% + 38px)); /* Adjusted from cm */
            width: 390px;
            height: 390px;
            z-index: 15;
        }

        .track {
            position: absolute;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 18.2px;
            text-align: center;
            background: transparent;
            z-index: 3;
        }

        .track:hover {
            transform: scale(1.1);
        }

        .track.playing {
            color: #00ff00;
            text-shadow: 0 0 5px #00ff00;
        }

        /* Track Positions */
        .track-0 { top: 26px; left: 130px; font-family: var(--font-press-start); }
        .track-1 { top: 65px; left: 65px; font-family: var(--font-rubik); }
        .track-2 { top: 130px; left: 26px; font-family: var(--font-comic); }
        .track-3 { top: 221px; left: 65px; font-family: var(--font-marker); }
        .track-4 { top: 260px; left: 130px; font-family: var(--font-caveat); }
        .track-5 { top: 221px; left: 195px; font-family: var(--font-press-start); }
        .track-6 { top: 130px; left: 234px; font-family: var(--font-rubik); }
        .track-7 { top: 65px; left: 195px; font-family: var(--font-comic); }

        /* --- Platform Links --- */
        .platform-links {
            position: fixed;
            bottom: 30px;
            left: 0;
            right: 0;
            display: none;
            justify-content: center;
            gap: 15px;
            z-index: 5;
        }

        .platform-link {
            color: rgba(255,255,255,0.7);
            text-decoration: none;
            display: flex;
            align-items: center;
            transition: all 0.3s ease;
            opacity: 0.8;
        }

        .platform-link:hover {
            opacity: 1;
            transform: scale(1.15);
            color: rgba(255,255,255,0.9);
        }

        .platform-emoji {
            font-size: 18px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(30,30,30,0.7);
            border-radius: 50%;
            padding: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            transition: all 0.3s ease;
        }

        .platform-link:hover .platform-emoji {
            background: rgba(50,50,50,0.8);
            box-shadow: 0 3px 12px rgba(0,0,0,0.4);
        }

        /* --- Progress Bar & Character --- */
        .progress-track {
            position: fixed;
            top: 40px;
            left: 25%;
            width: 50%;
            height: 4px;
            background: rgba(255,255,255,0.2);
            z-index: 99;
            display: none;
        }

        .progress-fill {
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 0%;
            background: var(--primary-color);
        }

        .game-character {
            position: fixed;
            top: 20px; /* Aligns with progress track */
            left: 25%;
            width: 40px;
            height: 40px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><rect x="9" y="10" width="6" height="8" fill="%239b59b6"/><rect x="8" y="14" width="8" height="2" fill="%236a3d8a"/><circle cx="11" cy="12" r="1" fill="%23000"/><circle cx="13" cy="12" r="1" fill="%23000"/></svg>');
            background-size: contain;
            background-repeat: no-repeat;
            z-index: 100;
            display: none;
            animation: walk 0.5s steps(2) infinite;
            cursor: ew-resize;
            /* Adjust transform to center character over the line */
            transform: translateY(-50%) translateX(-50%);
        }

        @keyframes walk {
            0%, 100% { transform: translateY(-50%) translateX(-50%); }
            50% { transform: translateY(-55%) translateX(-50%); } /* Slight lift */
        }

        /* --- Floating Draggable Image --- */
        #floatingImage {
            position: absolute;
            width: 40px;
            height: 40px;
            object-fit: cover;
            z-index: 20;
            display: none;
            cursor: grab;
            user-select: none;
            touch-action: none;
            border-radius: 50%;
            box-shadow: 0 3px 6px rgba(0,0,0,0.16);
            transition: transform 0.1s ease-out;
            border: none;
        }

        #floatingImage.grabbing {
            transform: scale(0.92);
            box-shadow: 0 5px 10px rgba(0,0,0,0.2);
            cursor: grabbing;
        }

        /* Smoke Trail Effect */
        .smoke-trail {
            position: absolute;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255,255,255,0.3) 0%, rgba(255,255,255,0) 70%);
            pointer-events: none;
            z-index: 19;
            transform: translate(-50%, -50%);
            opacity: 0;
            animation: smoke-fade 1.5s ease-out forwards;
        }

        @keyframes smoke-fade {
            0% {
                opacity: 0.7;
                transform: translate(-50%, -50%) scale(0.8);
            }
            100% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(1.5);
            }
        }

        /* --- AFEEGO Video --- */
        #afeegoVideoContainer {
            display: none;
            position: fixed;
            left: 20px;
            bottom: 20px;
            z-index: 100;
            background: transparent;
            padding: 0;
            max-width: 50%;
        }

        #afeegoVideo {
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            width: 240px;
            height: 135px;
        }


        /* --- Media Queries for Mobile --- */
        @media screen and (max-width: 768px) {
            body {
                background-attachment: scroll; /* Better performance on mobile */
                min-height: -webkit-fill-available;
            }

            html {
                height: -webkit-fill-available;
            }

            .slideshow-container {
                width: 80px;
                height: 80px;
            }

            .top-right-images {
                width: 80px;
                height: 80px;
                right: 15px;
                top: 15px;
            }

            .carousel-container {
                width: 300px;
                height: 300px;
            }

            .track {
                font-size: 14px;
            }

            .track-0 { top: 20px; left: 100px; }
            .track-1 { top: 50px; left: 50px; }
            .track-2 { top: 100px; left: 20px; }
            .track-3 { top: 170px; left: 50px; }
            .track-4 { top: 200px; left: 100px; }
            .track-5 { top: 170px; left: 150px; }
            .track-6 { top: 100px; left: 180px; }
            .track-7 { top: 50px; left: 150px; }

            .platform-links {
                bottom: 25px;
                gap: 12px;
            }

            .platform-emoji {
                font-size: 16px;
                width: 20px;
                height: 20px;
                padding: 6px;
            }

            .progress-track {
                top: 35px;
                height: 3px;
                left: 15%;
                width: 70%; /* Wider on mobile */
            }

            .game-character {
                width: 30px;
                height: 30px;
                left: 15%;
            }

            #floatingImage {
                width: 40px;
                height: 40px;
            }

            #afeegoVideoContainer {
                left: 10px;
                bottom: 10px;
                max-width: 60%;
            }

            #afeegoVideo {
                width: 160px;
                height: 90px;
            }
        }
    </style>
</head>
<body>

    <div id="container">

        <div class="emoji-wrapper">
            <span id="emoji" class="handwritten">üìº</span>
        </div>

        <span id="text" class="handwritten">RiverAdam$</span>

        <img id="floatingImage" src="RIVERADAMSME/1.jpg" alt="Floating Image">

        <div class="slideshow-container" id="slideshow">
            <div class="spinner"></div>
        </div>

        <div class="top-right-images" id="topRightImages">
            <img src="RIVERADAMSME/2.jpg" class="top-right-image" alt="RiverAdams 2">
        </div>

        <div class="carousel-container" id="carousel"></div>

        <div class="progress-track" id="progressTrack">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="game-character" id="gameCharacter"></div>

        <div class="platform-links" id="platformLinks">
            <a href="https://music.apple.com/us/artist/river-adams/1554125278" class="platform-link" target="_blank">
                <span class="platform-emoji apple">üçé</span>
            </a>
            <a href="https://www.youtube.com/@RiverAdamsMusic" class="platform-link" target="_blank">
                <span class="platform-emoji youtube">‚ñ∂Ô∏è</span>
            </a>
            <a href="https://open.spotify.com/artist/5ZV6CFDURLSarqDL7Wwn6n?si=0H_HMr3dTQefGaHi7RX7FQ" class="platform-link" target="_blank">
                <span class="platform-emoji spotify">üéµ</span>
            </a>
            <a href="https://www.instagram.com/riveradamsmusic/" class="platform-link" target="_blank">
                <span class="platform-emoji instagram">üì∏</span>
            </a>
        </div>

        <div id="afeegoVideoContainer">
            <video id="afeegoVideo" width="320" height="180" controls>
                <source src="AFEEGO/1.mp4" type="video/mp4">
                Your browser does not support the video tag.
            </video>
        </div>

        <div class="flick-instruction" id="flickInstruction">
            Flick
            <div class="flick-arrow">‚Üì</div>
        </div>

    </div>

    <script>
        'use strict';

        // Since the script is at the end of the body, DOMContentLoaded is not strictly necessary,
        // but it's a robust practice to ensure all elements are available.
        document.addEventListener('DOMContentLoaded', () => {

            // --- Constants ---
            const GLITCH_FLASHES = 6;
            const GLITCH_INTERVAL_MS = 100;
            const SLIDESHOW_INTERVAL_MS = 3000;
            const SMOKE_INTERVAL_MS = 100;
            const SMOKE_DURATION_MS = 1500;
            const FLOATING_IMAGE_FRICTION = 0.98;
            const FLOATING_IMAGE_BOUNCE = 0.7;
            const FLOATING_IMAGE_THROW_POWER = 2.2;

            const AUDIO_FILES = [
                { name: "21 Century", file: "RIVERADAMS/21_Century_copy.mp3" },
                { name: "Grey", file: "RIVERADAMS/grey_copy.mp3" },
                { name: "ùêåùê´. ùêíùê®Ã∑ùê•ùê®Ã∑", file: "RIVERADAMS/Mr_Solo_copy.mp3" },
                { name: "Opportunities", file: "RIVERADAMS/Opportunities_copy.mp3" },
                { name: "Rap (feat. AFEEGO)", file: "RIVERADAMS/Rap_feat_AFEEGO_copy.mp3" },
                { name: "Spoken Word", file: "RIVERADAMS/Spoken_Word_copy.mp3" },
                { name: "Trying", file: "RIVERADAMS/Trying_copy.mp3" },
                { name: "ùì¶ùîÇùì∑ùîÄùì∏ùì∏ùì≠", file: "RIVERADAMS/Wynwood_copy_Wav.mp3" }
            ];

            const PHOTO_FILES = Array.from({ length: 11 }, (_, i) => `RIVERADAMSPICZ/${i + 1}.jpg`);

            // --- DOM Elements ---
            const elements = {
                emoji: document.getElementById('emoji'),
                emojiWrapper: document.querySelector('.emoji-wrapper'),
                text: document.getElementById('text'),
                carousel: document.getElementById('carousel'),
                slideshow: document.getElementById('slideshow'),
                topRightImages: document.getElementById('topRightImages'),
                platformLinks: document.getElementById('platformLinks'),
                gameCharacter: document.getElementById('gameCharacter'),
                progressTrack: document.getElementById('progressTrack'),
                progressFill: document.getElementById('progressFill'),
                spinner: document.querySelector('.spinner'),
                floatingImage: document.getElementById('floatingImage'),
                afeegoVideoContainer: document.getElementById('afeegoVideoContainer'),
                afeegoVideo: document.getElementById('afeegoVideo'),
                flickInstruction: document.getElementById('flickInstruction'),
            };

            // --- State Variables ---
            let state = {
                currentAudio: null,
                currentPlayingTrack: null,
                audioContext: null,
                slideInterval: null,
                currentSlideIndex: 0,
                isCharacterDragging: false,
                isFloatingImageDragging: false,
                hasAfeegoVideoPlayed: false,
                progressUpdateInterval: null,
            };

            // --- Floating Image Physics State ---
            let floatingImageState = {
                lastX: 0,
                lastY: 0,
                currentX: 0,
                currentY: 0,
                velocityX: 0,
                velocityY: 0,
                lastSmokeTime: 0,
                animationFrameId: null,
            };

            // --- Slideshow Functions ---
            const createSlideshow = () => {
                elements.spinner.style.display = 'block';
                elements.slideshow.style.display = 'block';

                const slidesToLoad = PHOTO_FILES.filter(file => !file.includes('1.jpg'));
                let loadedImages = 0;
                const totalImages = slidesToLoad.length;

                if (totalImages === 0) {
                    elements.spinner.style.display = 'none';
                    return;
                }

                const onImageLoad = () => {
                    loadedImages++;
                    if (loadedImages === totalImages) {
                        elements.spinner.style.display = 'none';
                        startSlideshow();
                    }
                };

                slidesToLoad.forEach((photo, index) => {
                    const slide = document.createElement('img');
                    slide.className = 'slide';
                    slide.src = photo;
                    slide.alt = `RiverAdams photo ${index + 2}`;
                    slide.onload = onImageLoad;
                    slide.onerror = () => {
                        console.error(`Failed to load image: ${photo}`);
                        onImageLoad(); // Still count it to finish loading
                    };
                    elements.slideshow.appendChild(slide);
                });
            };

            const startSlideshow = () => {
                const slides = elements.slideshow.querySelectorAll('.slide');
                if (slides.length === 0) return;

                slides[0].classList.add('active');

                state.slideInterval = setInterval(() => {
                    slides[state.currentSlideIndex].classList.remove('active');
                    state.currentSlideIndex = (state.currentSlideIndex + 1) % slides.length;
                    slides[state.currentSlideIndex].classList.add('active');
                }, SLIDESHOW_INTERVAL_MS);
            };

            // --- Glitch Text Effect ---
            const showGlitchText = () => {
                elements.text.style.display = 'block';
                elements.text.style.opacity = '1';
                let flashCount = 0;

                const flash = setInterval(() => {
                    const effects = ['intense-glitch', 'font-press-start', 'font-major-mono'];
                    const randomEffect = effects[Math.floor(Math.random() * effects.length)];
                    elements.text.className = `handwritten ${randomEffect}`;
                    flashCount++;

                    if (flashCount >= GLITCH_FLASHES) {
                        clearInterval(flash);
                        elements.text.className = 'handwritten font-caveat';
                        elements.text.style.cssText = `
                            color: white;
                            transform: translate(-50%, -50%);
                            animation: none;
                            display: block;
                            opacity: 1;
                        `;

                        // Transition to main content
                        setTimeout(() => {
                            elements.text.style.display = 'none';
                            elements.carousel.style.display = 'block';
                            elements.topRightImages.style.display = 'flex';
                            elements.platformLinks.style.display = 'flex';
                            elements.flickInstruction.style.display = 'flex';
                            createSlideshow();
                            initCarousel();
                            initFloatingImage();
                        }, 300);
                    }
                }, GLITCH_INTERVAL_MS);
            };

            // --- Audio and Progress Bar ---
            const updateProgressBar = () => {
                if (state.currentAudio && !state.isCharacterDragging) {
                    const progress = (state.currentAudio.currentTime / state.currentAudio.duration) * 100;
                    elements.progressFill.style.width = `${progress}%`;
                    const newPosition = (progress / 100) * elements.progressTrack.offsetWidth;
                    elements.gameCharacter.style.transform = `translateX(${newPosition}px) translateY(-50%) translateX(-50%)`;
                }
            };

            const handleScrub = (event) => {
                if (!state.currentAudio || state.isFloatingImageDragging) return;
                
                const clientX = event.clientX ?? event.touches?.[0]?.clientX;
                if (clientX === undefined) return;

                const rect = elements.progressTrack.getBoundingClientRect();
                let scrubPosition = (clientX - rect.left) / rect.width;
                scrubPosition = Math.max(0, Math.min(1, scrubPosition));

                state.currentAudio.currentTime = scrubPosition * state.currentAudio.duration;
                updateProgressBar();
            };
            
            const setupProgressInteraction = () => {
                const startScrub = (e) => {
                    state.isCharacterDragging = true;
                    document.addEventListener('mousemove', handleScrub);
                    document.addEventListener('touchmove', handleScrub, { passive: false });
                    document.addEventListener('mouseup', endScrub);
                    document.addEventListener('touchend', endScrub);
                };

                const endScrub = () => {
                    state.isCharacterDragging = false;
                    document.removeEventListener('mousemove', handleScrub);
                    document.removeEventListener('touchmove', handleScrub);
                    document.removeEventListener('mouseup', endScrub);
                    document.removeEventListener('touchend', endScrub);
                };
                
                elements.gameCharacter.addEventListener('mousedown', startScrub);
                elements.gameCharacter.addEventListener('touchstart', startScrub, { passive: false });
                elements.progressTrack.addEventListener('click', handleScrub);
            };

            const playTrack = (track, index, element) => {
                if (state.currentAudio) {
                    state.currentAudio.pause();
                    cleanupCharacterAnimation();
                }

                state.currentAudio = new Audio(track.file);
                state.currentPlayingTrack = index;
                
                document.querySelectorAll('.track').forEach(t => t.classList.remove('playing'));
                element.classList.add('playing');
                
                state.currentAudio.play().catch(e => console.error("Audio play failed:", e));

                state.currentAudio.onplay = () => {
                    elements.gameCharacter.style.display = 'block';
                    elements.progressTrack.style.display = 'block';
                    state.progressUpdateInterval = setInterval(updateProgressBar, 100);
                };

                state.currentAudio.onended = () => {
                    element.classList.remove('playing');
                    state.currentPlayingTrack = null;
                    cleanupCharacterAnimation();
                };
            };
            
            const cleanupCharacterAnimation = () => {
                clearInterval(state.progressUpdateInterval);
                elements.progressTrack.style.display = 'none';
                elements.gameCharacter.style.display = 'none';
                elements.progressFill.style.width = '0%';
            };

            // --- Carousel Initialization ---
            const initCarousel = () => {
                AUDIO_FILES.forEach((track, index) => {
                    const trackElement = document.createElement('div');
                    trackElement.className = `track track-${index % 8}`;
                    trackElement.textContent = track.name;
                    trackElement.dataset.index = index;
                    elements.carousel.appendChild(trackElement);

                    trackElement.addEventListener('click', async () => {
                        if (state.currentPlayingTrack === index && state.currentAudio) {
                            state.currentAudio.paused ? state.currentAudio.play() : state.currentAudio.pause();
                            trackElement.classList.toggle('playing', !state.currentAudio.paused);
                            return;
                        }

                        if (track.name.includes("AFEEGO") && !state.hasAfeegoVideoPlayed) {
                            state.hasAfeegoVideoPlayed = true;
                            elements.afeegoVideoContainer.style.display = 'block';
                            elements.afeegoVideo.currentTime = 0;
                            
                            elements.afeegoVideo.onended = () => {
                                elements.afeegoVideoContainer.style.display = 'none';
                                playTrack(track, index, trackElement);
                            };
                            
                            try {
                                await elements.afeegoVideo.play();
                            } catch (e) {
                                console.error("Video play failed:", e);
                                elements.afeegoVideoContainer.style.display = 'none';
                                playTrack(track, index, trackElement);
                            }
                        } else {
                            playTrack(track, index, trackElement);
                        }
                    });
                });
            };
            
            // --- Floating Image and Smoke Effect ---
            const createSmokeTrail = (x, y) => {
                const now = Date.now();
                if (now - floatingImageState.lastSmokeTime < SMOKE_INTERVAL_MS) return;
                floatingImageState.lastSmokeTime = now;

                const smoke = document.createElement('div');
                smoke.className = 'smoke-trail';
                smoke.style.left = `${x}px`;
                smoke.style.top = `${y}px`;
                document.body.appendChild(smoke);

                setTimeout(() => smoke.remove(), SMOKE_DURATION_MS);
            };

            const updateFloatingImage = () => {
                if (!state.isFloatingImageDragging) {
                    floatingImageState.velocityX *= FLOATING_IMAGE_FRICTION;
                    floatingImageState.velocityY *= FLOATING_IMAGE_FRICTION;

                    floatingImageState.currentX += floatingImageState.velocityX;
                    floatingImageState.currentY += floatingImageState.velocityY;

                    // Boundary checks with bounce
                    const { offsetWidth, offsetHeight } = elements.floatingImage;
                    if (floatingImageState.currentX < 0) {
                        floatingImageState.currentX = 0;
                        floatingImageState.velocityX *= -FLOATING_IMAGE_BOUNCE;
                    } else if (floatingImageState.currentX > window.innerWidth - offsetWidth) {
                        floatingImageState.currentX = window.innerWidth - offsetWidth;
                        floatingImageState.velocityX *= -FLOATING_IMAGE_BOUNCE;
                    }
                    if (floatingImageState.currentY < 0) {
                        floatingImageState.currentY = 0;
                        floatingImageState.velocityY *= -FLOATING_IMAGE_BOUNCE;
                    } else if (floatingImageState.currentY > window.innerHeight - offsetHeight) {
                        floatingImageState.currentY = window.innerHeight - offsetHeight;
                        floatingImageState.velocityY *= -FLOATING_IMAGE_BOUNCE;
                    }

                    if (Math.abs(floatingImageState.velocityX) > 0.1 || Math.abs(floatingImageState.velocityY) > 0.1) {
                        createSmokeTrail(floatingImageState.currentX + offsetWidth / 2, floatingImageState.currentY + offsetHeight / 2);
                    }
                }
                
                elements.floatingImage.style.left = `${floatingImageState.currentX}px`;
                elements.floatingImage.style.top = `${floatingImageState.currentY}px`;
                
                floatingImageState.animationFrameId = requestAnimationFrame(updateFloatingImage);
            };

            const initFloatingImage = () => {
                elements.floatingImage.style.display = 'block';
                floatingImageState.currentX = window.innerWidth * 0.1;
                floatingImageState.currentY = window.innerHeight * 0.2;
                
                let throwVector = { x: 0, y: 0 };
                
                const handleDragStart = (e) => {
                    state.isFloatingImageDragging = true;
                    elements.floatingImage.classList.add('grabbing');
                    elements.flickInstruction.style.display = 'none'; // Hide on first interaction
                    
                    const coords = getEventCoordinates(e);
                    floatingImageState.lastX = coords.x;
                    floatingImageState.lastY = coords.y;

                    e.preventDefault();
                };
                
                const handleDragMove = (e) => {
                    if (!state.isFloatingImageDragging) return;
                    
                    const coords = getEventCoordinates(e);
                    throwVector.x = coords.x - floatingImageState.lastX;
                    throwVector.y = coords.y - floatingImageState.lastY;
                    
                    floatingImageState.currentX += throwVector.x;
                    floatingImageState.currentY += throwVector.y;
                    
                    floatingImageState.lastX = coords.x;
                    floatingImageState.lastY = coords.y;
                    
                    e.preventDefault();
                };
                
                const handleDragEnd = () => {
                    if (!state.isFloatingImageDragging) return;
                    state.isFloatingImageDragging = false;
                    elements.floatingImage.classList.remove('grabbing');
                    
                    floatingImageState.velocityX = throwVector.x * FLOATING_IMAGE_THROW_POWER * 0.3;
                    floatingImageState.velocityY = throwVector.y * FLOATING_IMAGE_THROW_POWER * 0.3;
                };
                
                elements.floatingImage.addEventListener('mousedown', handleDragStart);
                elements.floatingImage.addEventListener('touchstart', handleDragStart, { passive: false });
                
                document.addEventListener('mousemove', handleDragMove);
                document.addEventListener('touchmove', handleDragMove, { passive: false });
                
                document.addEventListener('mouseup', handleDragEnd);
                document.addEventListener('touchend', handleDragEnd);
                
                updateFloatingImage();
            };
            
            const getEventCoordinates = (e) => {
                if (e.touches) {
                    return { x: e.touches[0].clientX, y: e.touches[0].clientY };
                }
                return { x: e.clientX, y: e.clientY };
            };

            // --- Initial Event Listener ---
            elements.emojiWrapper.addEventListener('click', async () => {
                // Initialize AudioContext on user interaction
                if (!state.audioContext) {
                    try {
                        state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                        await state.audioContext.resume();
                    } catch (e) {
                        console.error("AudioContext could not be resumed.", e);
                    }
                }

                elements.emoji.classList.add('fade-out');
                
                // Wait for fade-out animation before showing glitch text
                setTimeout(() => {
                    elements.emojiWrapper.style.display = 'none';
                    showGlitchText();
                }, 500);
            });

            // --- Setup Interactions that require DOM elements ---
            setupProgressInteraction();
        });
    </script>
</body>
</html>
